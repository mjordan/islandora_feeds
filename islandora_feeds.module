<?php

/**
 * @file
 * Defines all the hooks this module implements.
 */

/**
 * Implements hook_menu(). Much code borrowed from field_ui.module.
 */
function islandora_feeds_menu() {
  // Create tabs for all possible bundles.
  foreach (entity_get_info() as $entity_type => $entity_info) {
    foreach ($entity_info['bundles'] as $bundle_name => $bundle_info) {
      if (isset($bundle_info['admin'])) {
        // Extract path information from the bundle.
        $path = $bundle_info['admin']['path'];
        if (isset($bundle_info['admin']['bundle argument'])) {
          $bundle_arg = $bundle_info['admin']['bundle argument'];
          $bundle_pos = (string) $bundle_arg;
        }
        else {
          $bundle_arg = $bundle_name;
          $bundle_pos = '0';
        }
        // Extract access information, providing defaults.
        $access = array_intersect_key($bundle_info['admin'], drupal_map_assoc(array('access callback', 'access arguments')));
        $access += array(
          'access callback' => 'user_access',
          'access arguments' => array('administer site configuration'),
        );

        // We only want the node entities, not the comment node entities.
          if (preg_match('/\/manage\/%node_type$/', $path)) {
          // 'Islandora Feeds schema' tab.
          $items["$path/islandora_feeds_xsd"] = array(
            'title' => 'Islandora Feeds schema',
            'page callback' => 'drupal_get_form',
            'page arguments' => array('islandora_feeds_generate_xsd_form', $bundle_arg),
            'type' => MENU_LOCAL_TASK,
            'weight' => 20,
          ) + $access;
        }
      }
    }
  }
  return $items;
}

/**
 * Form constructor for the Islandora Feeds XSD generation tool.
 * No submit button or callback is required.
 */
function islandora_feeds_generate_xsd_form($form, &$form_state, $bundle_arg) {
  module_load_include('inc', 'islandora_feeds', 'includes/utilities');
  $form['schema'] = array(
    '#type' => 'textarea',
    '#title' => t('Current schema'),
    '#default_value' => theme('schema_xsd', array('content_type' => $bundle_arg->type)),
    '#rows' => 20,
    '#description' => t('Copy this and paste it into...'),
  );
  return $form;  
}

/**
 * Implements hook_feeds_plugins().
 */
function islandora_feeds_feeds_plugins() {
  $info = array();
  $info['IslandoraFeedsFeedsNodeProcessor'] = array(
    'name' => 'Islandora Feeds node processor',
    'description' => 'Creates Islandora objects. Corresponding nodes are not created.',
    'handler' => array(
      'parent' => 'FeedsProcessor',
      'class' => 'IslandoraFeedsFeedsNodeProcessor',
      'file' => 'IslandoraFeedsFeedsNodeProcessor.inc',
      'path' => drupal_get_path('module', 'islandora_feeds'),
    ),
  );
  return $info;
}

/**
 * Implements hook_theme().
 */
function islandora_feeds_theme($existing, $type, $theme, $path) {
  return array(
    'schema_xsd' => array(
      'template' => 'theme/schema',
      'variables' => array('content_type' => NULL),
    ),
    'islandora_feeds_item_display' => array(
      'template' => 'theme/item-display',
      'pattern' => 'islandora_feeds__',
      'variables' => array('islandora_object' => NULL),
    ),
    'islandora_feeds_item_ingest' => array(
      'template' => 'theme/item-ingest',
      'pattern' => 'islandora_feeds__',
      'variables' => array('node' => NULL),
    ),
  );
}

/**
 * Implements hook_preprocess_theme().
 */
function islandora_feeds_preprocess_islandora_feeds_item_display(array &$variables) {
  $islandora_object = $variables['islandora_object'];
  $variables['islandora_content'] = htmlspecialchars($islandora_object['OBJ']->content);
}

/**
 * Implements hook_preprocess_theme().
 */
function islandora_feeds_preprocess_islandora_feeds_item_ingest(array &$variables) {
  $node = $variables['node'];
  $variables['title'] = $node->title;
  $object_fields = field_info_instances("node", $node->type);
  // @todo: Add support for multiple field instances.
  foreach ($object_fields as $field_name => $info) {
    $variables[$field_name] = $node->{$field_name}['und'][0]['value'];
  }
}

/**
 * Implements hook_preprocess_theme().
 */
function islandora_feeds_preprocess_schema_xsd(array &$variables) {
  $content_type = $variables['content_type'];
  $content_type_cammel_words = explode('_', $content_type);
  foreach ($content_type_cammel_words as &$word) {
    $word = ucfirst($word);
  }
  $variables['content_type_cammel'] = implode('', $content_type_cammel_words);
  $object_fields = field_info_instances("node", $content_type);

  // Placeholder, not currently used.
  // if (module_exists('field_group')) {
    // $object_field_groups = field_group_info_groups("node", $content_type);
  // }

  $fields = array('title');
  foreach ($object_fields as $field_name => $info) {
    // Remove 'field_'.
    $field_name = preg_replace('/^field_/', '', $field_name);
    $fields[] = $field_name;
  }
  $variables['fields'] = $fields;
  $variables['documentation'] = "Generated by the Islandora Feeds module " 
    . date(DATE_RFC2822) . ".\n";
}

/**
 * Implements hook_CMODEL_PID_islandora_view_object().
 */
function islandora_feeds_islandora_feedsCModel_islandora_view_object($object, $page_number, $page_size) {
  $output = theme('islandora_feeds_item_display', array('islandora_object' => $object));
  return array('' => $output);
}

/**
 * Implements hook_action_info().
 */
function islandora_feeds_action_info() {
  return array(
    'islandora_feeds_create_islandora_objects_action' => array(
      'type' => 'node',
      'label' => t('Create Islandora objects from nodes'),
      'configurable' => FALSE,
      'vbo_configurable' => TRUE,
      'pass rows' => TRUE,
      'triggers' => array('any'),
    ),
  );
}

/**
 * Form to configure the 'Create Islandora objects from nodes' action.
 */
function islandora_feeds_create_islandora_objects_action_form($context) {
  $types = node_type_get_types();
  $types_options = array();
  foreach ($types as $type => $properties) {
    $types_options[$type] = $properties->name;
  }
  $form['bundle'] = array(
    '#type' => 'select',
    '#title' => t('Bundle'),
    '#options' => $types_options,
    '#description' => t("The content type bundle that the objects will be created from."),
    '#required' => TRUE,
  );
  module_load_include('inc', 'islandora_feeds', 'includes/utilities');
  $collections = islandora_feeds_get_collections_or_content_models('collections');
  $form['collection'] = array(
    '#type' => 'select',
    '#title' => t('Target collection'),
    '#options' => $collections,
    '#description' => t("The Islandora collection you want to import into."),
    '#required' => TRUE,
  );
  $cmodels = islandora_feeds_get_collections_or_content_models('cmodels');
  $form['cmodel'] = array(
    '#type' => 'select',
    '#title' => t('Target content model'),
    '#options' => $cmodels,
    '#default_value' => 'islandora:feedsCModel',
    '#description' => t("The Islandora content model you want to import into."),
    '#required' => TRUE,
  );
  $form['namespace'] = array(
      '#type' => 'textfield',
      '#title' => t('Namespace'),
      '#description' => t('The PID namespace to use for the imported objects.'),
      '#required' => TRUE,
  );
  $author = user_load_by_name('admin');
  $form['author'] = array(
    '#type' => 'textfield',
    '#title' => t('Author'),
    '#description' => t('Select the author of the nodes to be created - leave empty to assign "anonymous".'),
    '#autocomplete_path' => 'user/autocomplete',
    '#default_value' => empty($author->name) ? 'anonymous' : check_plain($author->name),
  );
  return $form;
}

/**
 * Custom action. Fired from Views Bulk Operations.
 */
function islandora_feeds_create_islandora_objects_action($object, $context) {
  module_load_include('inc', 'islandora_feeds', 'includes/utilities');
  islandora_feeds_ingest_object($entity, $namespace, $xml_ds, $cmodel, $collection);
}

/**
 * Action submit function.
 */
function islandora_feeds_create_islandora_objects_action_submit($form, $form_state) {
  return array(
    'bundle' => $form_state['values']['bundle'],
    'collection' => $form_state['values']['collection'],
    'cmodel' => $form_state['values']['cmodel'],
    'author' => $form_state['values']['author'],
  );
}

/**
 * Implements hook_islandora_required_objects().
 */
function islandora_feeds_islandora_required_objects(IslandoraTuque $connection) {
  $module_path = drupal_get_path('module', 'islandora_feeds');
  $islandora_path = drupal_get_path('module', 'islandora');

  $islandora_feeds_content_model = $connection->repository->constructObject('islandora:feedsCModel');
  $islandora_feeds_content_model->owner = 'fedoraAdmin';
  $islandora_feeds_content_model->label = 'Islandora Feeds Content Model';
  $islandora_feeds_content_model->models = 'fedora-system:ContentModel-3.0';

  // DS-COMPOSITE-MODEL Datastream.
  $datastream = $islandora_feeds_content_model->constructDatastream('DS-COMPOSITE-MODEL', 'X');
  $datastream->label = 'DS-COMPOSITE-MODEL';
  $datastream->mimetype = 'text/xml';
  $datastream->setContentFromFile("$module_path/xml/islandora_feeds_ds_composite_model.xml", FALSE);
  $islandora_feeds_content_model->ingestDatastream($datastream);

  return array(
    'islandora_feeds' => array(
      'title' => 'Islandora Feeds',
      'objects' => array(
        $islandora_feeds_content_model,
      ),
    ),
  );
}

